name: Build code
on: 
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:
  
jobs:
  build-linux:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: make blakserv
      working-directory: blakserv
      run: make -f makefile.linux -k
      
    - name: make kod
      working-directory: blakcomp
      run: |
        make -f makefile.linux -k
        cd ../kod
        make -f makefile.linux

  build-mac:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: make blakserv
      working-directory: blakserv
      run: make -f makefile.linux -k
      
    - name: make kod
      working-directory: blakcomp
      run: |
        make -f makefile.linux -k
        cd ../kod
        make -f makefile.linux

  
  build-windows-32:
  
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: ilammy/msvc-dev-cmd@v1
      with: 
        arch: x86
        
    - name: make client 32-bit
      run: |
        nmake /nologo Bclient Bmodules Bupdater

    - name: make server 32-bit
      run: |
        nmake /nologo Bserver


  build-windows-64:
  
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: ilammy/msvc-dev-cmd@v1
      with: 
        arch: x64
        
    - name: make client 64-bit
      run: |
        nmake /nologo Bclient Bmodules Bupdater

    - name: make server 64-bit
      run: |
        nmake /nologo Bserver


  build-linux-cmake:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y cmake g++ mingw-w64 flex bison python3

    - name: Configure
      run: cmake -B build

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Verify native binaries
      run: |
        file run/server/blakserv | grep -q "ELF"
        file bin/bc | grep -q "ELF"

    - name: Verify cross-compiled binaries
      run: |
        file run/localclient/meridian.exe | grep -q "PE32"
        file run/localclient/resource/merintr.dll | grep -q "PE32"

    - name: Verify kod compilation
      run: |
        test $(ls run/server/loadkod/*.bof | wc -l) -gt 1000
